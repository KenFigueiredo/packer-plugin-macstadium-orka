## Packer Builder Configuration

# Compatibility

For this plugin to function you need to have at least Packer 1.7.0 installed.
The Orka CLI is optional as of v2.0.0 but is highly recommended to allow
you to access the Orka API for other tasks (such as tweaking, deleting or managing the
VMs and images) whilst building your packer logic via this plugin.

- **[Packer Downloads]** - 1.7.0+
- **[Orka CLI Downloads]** (Optional) - 1.3.0+

# JSON

```json
{
  "builders": [
    {
      "type": "macstadium-orka",
      "source_image": "name-of-image-from-vm-images-list",
      "image_name": "destination-image-name",
      "orka_endpoint": "orka-endpoint",
      "orka_user": "orka-user",
      "orka_password": "orka-password"
    }
  ]
}
```

# HCL

```hcl
source "macstadium-orka" "image" {
  source_image    = "name-of-image-from-vm-images-list"
  image_name      = "destination-image-name"
  orka_endpoint   = "orka-endpoint"
  orka_user       = "orka-user"
  orka_password   = "orka-password"
}

build {
  sources = [
    "macstadium-orka.image"
  ]
  provisioner "shell" {
    inline = [
      "echo we are running on the remote host",
      "hostname",
      "touch .we-ran-packer-successfully"
    ]
  }
}
```

# Variables

- `type` _(string)_ **(required)**: Must be `macstadium-orka`

- `source_image` _(string)_ **(required)**: This is the source image (vm config) we will be using to launch the VM from.

- `image_name` _(string)_ (optional): This is the destination name of the image that will be created. The image will be located inside `orka image list` when completed. If not specified this will be autogenerated to the following: `packer-{{unix timestamp}}`

- `orka_endpoint` _(string)_ (optional): The orka api endpoint to use

- `orka_user` _(string)_ **(required)**: User that exists in the cluster

- `orka_password` _(string)_ **(required)**: Password for the orka user

- `ssh_user` _(string)_ (optional): User on the virtual machine

- `ssh_password` _(string)_ (optional): Password for the virtual machine user

- `orka_vm_builder_name` _(string)_ (optional): Name of the virtual machine that builds the image

- `orka_vm_builder_prefix` _(string)_ (optional): If orka_vm_builder_name is not passed in, you can add prefix to the virtual machine name that the plugin appends a timestamp to. Defaults to packer.

- `orka_enable_io_boost` _(bool)_ (optional): Enable [Boost IO Performance](https://orkadocs.macstadium.com/docs/boost-io-performance), off by default

- `orka_vm_cpu_core` _(int)_ (optional): Number of cpu cores to use with the virtual machine.

- `image_precopy` _(bool)_ (optional): The plugin defaults to using image save. If this option is set to true, the builder will commit the image and perform an image copy.

# Development / Internal Variables

If you're NOT a dev working on this software you can ignore the following.

But, if you are building/editing/updating this software, you may want to turn on most or all of the following options. See the [examples/orka.pkr.hcl](./examples/orka.pkr.hcl) or [examples/macos.json](./examples/macos-catalina.json).

- `do_not_delete` _(boolean)_ (optional) _*- for devs*_: By default this plugin automatically deletes the VM afterwards if all scripts ran successfully. This is useful for debugging builds.

- `do_not_image` _(boolean)_ (optional) _*- for devs*_ By default this plugin automatically creates an image of the VM after any provisioning steps. This is useful for debugging builds.

# Information Notes / Gotchas

[MacStadium Orka] base images have SSH enabled by default and the username/password is `admin:admin` because they are within' a private network by default. So this plugin has those credentials hardcoded by default, but you can of course customize the communicator. See the options from the [SSH Communicator].

# Example Orka CLI Commands

These aren't directly related to this plugin, exactly, but they're a bit of a simplified guide to get you started. For a more full guide see: [Orka Setup Guide].

```bash
# Create a config which is used for source_image above
orka vm create-config -v <vm-name> -c 3 --C 3 --vnc --base-image <base-image> -y

# In essence, this plugin automates running the following 3 commands...
# Start a VM (using the config above)
orka vm deploy -v macos-catalina-10-15-5 --vnc -y

# Save a VM's disk to a disk image
orka image save -v <vmid-here-from-orka-vm-list> -b <destination-image-name> -y

# Stop and remove a VM
orka vm delete --vm <vmid-here-from-orka-vm-list> -y

# Later to launch future images with this image create a new config to launch...
orka vm create-config -v <my-new-packerified-vm> -c 3 --C 3 --vnc --base-image <destination-image-name> -y
# And launch it...
orka vm deploy -v my-new-packerified-vm --vnc -y
# Or, alternatively if you're done working with an image and want to delete it...
orka image delete --image <destination-image-name> -y
```

## Changelog / History

- [v2.3.0] - Update the orka packer plugin to be compatible with packer 1.7.0
- [v2.2.1] - Add better error handling when using the save or commit endpoints to ensure that the build halts and errors as well.
- [v2.0.0] - Refactored to use the Orka API directly as opposed to having to wrap the CLI tool.
- [v1.0.0] - Initial Public Release
  - Basic functionality wrapper around Orka CLI
  - Setup Github Action to automatically build and release

## Development / Bugs / Support

If you want to help contribute to this plugin or find a bug, please [file an issue] on Github, and/or submit me a PR. This is Open Source, so don't expect me to fix bugs immediately, but I'll try my best to reasonably support this plugin. Contributors are always welcome though.

To get a development environment up will need a recent golang installed and setup. Then with a single make command below command it will build, install, and try to run the example at [examples/orka.pkr.hcl](./examples/orka.pkr.hcl). You may need to edit this file to have the source VM config that you have locally, as it is hardcoded to my environment's image `macos-catalina-10-15-5` at the moment.

```bash
make fresh
```

or

```bash
make rebuild
```

## Todo (in no particular order)

These are a list of things that are pending to accomplish within' this repo. Contributors welcome, I might do some of these also, eventually.

- Add more tests
- Add image management features into the builder instead of having to manage out-of-band with orka cli (eg: delete image)
- Consider implementing for this plugin to automatically create a VM Config (before launching a VM, and possibly after tied to the image just created)
- Add the ability for this plugin to be able to scan configs and/or images available and automatically use the first one it finds, possibly creating a new config specifically for the image?
- Improve the JSON parsing code. See: line 137-176 of [builder/orka/step_orka_create.go](./builder/orka/step_orka_create.go) and look at the function `ExtractIPHost` in that file as well. Could be much improved and hopefully simplified. Contributors welcome!!!
- Clean up / improve code / catch more sharp edges and edge-cases, deal with any issues filed on Github.
- One day, get this merged upstream into Packer as an official packer plugin. Additional info [here](https://www.packer.io/docs/plugins/packer-integration-program)

## Original Author / License

This plugin is "very-loosely" based-on and took inspiration from the [Packer Null Builder], [Packer LXD Builder], and the [Packer Builder Veertu Anka].

- Written by [Farley Farley] ( farley _at_ neonsurge **dawt** com )
- License Terms: [GNU GPL v3]

[//]: <> (Ignore, below here are links for ease-of-use above)
[Packer]: https://www.packer.io/
[Packer Builder]: https://www.packer.io/docs/extending/custom-builders.html
[MacStadium Orka]: https://www.macstadium.com/orka
[Orka]: https://www.macstadium.com/orka
[MacStadium]: https://www.macstadium.com
[Packer Downloads]: https://www.packer.io/downloads.html
[Orka CLI Downloads]: https://orkadocs.macstadium.com/docs/downloads
[Orka Setup Guide]: https://orkadocs.macstadium.com/docs/quick-start
[Latest Release]: https://github.com/lumoslabs/packer-builder-macstadium-orka/releases
[Farley Farley]: https://github.com/andrewfarley
[GNU GPL v3]: https://choosealicense.com/licenses/gpl-3.0/
[v1.0.0]: https://github.com/macstadium/packer-plugin-macstadium-orka/releases/tag/v1.0.0
[v2.0.0]: https://github.com/macstadium/packer-plugin-macstadium-orka/releases/tag/v2.0.0
[v2.2.1]: https://github.com/macstadium/packer-plugin-macstadium-orka/releases/tag/v2.2.1
[v2.3.0]: https://github.com/macstadium/packer-plugin-macstadium-orka/releases/tag/v2.3.0
[SSH Communicator]: https://www.packer.io/docs/communicators/ssh
[Packer Builder Veertu Anka]: https://github.com/veertuinc/packer-builder-veertu-anka
[Packer Null Builder]: https://github.com/hashicorp/packer/tree/master/builder/null
[Packer LXD Builder]: https://github.com/hashicorp/packer/tree/master/builder/lxd
[file an issue]: https://github.com/macstadium/packer-plugin-macstadium-orka/issues
